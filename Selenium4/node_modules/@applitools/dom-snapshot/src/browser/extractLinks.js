'use strict';

function extractLinks(doc = document) {
  const srcsetUrls = [...doc.querySelectorAll('img[srcset],source[srcset]')]
    .map(srcsetEl =>
      srcsetEl
        .getAttribute('srcset')
        .split(',')
        .map(str => str.trim().split(/\s+/)[0]),
    )
    .reduce((acc, urls) => acc.concat(urls), []);

  const srcUrls = [...doc.querySelectorAll('img[src],source[src]')].map(srcEl =>
    srcEl.getAttribute('src'),
  );

  const imageUrls = [...doc.querySelectorAll('image,use')]
    .map(hrefEl => hrefEl.getAttribute('href') || hrefEl.getAttribute('xlink:href'))
    .filter(u => u && u[0] !== '#');

  const objectUrls = [...doc.querySelectorAll('object')]
    .map(el => el.getAttribute('data'))
    .filter(Boolean);

  const cssUrls = [...doc.querySelectorAll('link[rel="stylesheet"]')].map(link =>
    link.getAttribute('href'),
  );

  const videoPosterUrls = [...doc.querySelectorAll('video[poster]')].map(videoEl =>
    videoEl.getAttribute('poster'),
  );

  return [...srcsetUrls, ...srcUrls, ...imageUrls, ...cssUrls, ...videoPosterUrls, ...objectUrls];
}

module.exports = extractLinks;
