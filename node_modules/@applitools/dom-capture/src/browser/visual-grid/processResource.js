'use strict';
const filterInlineUrl = require('./filterInlineUrl');
const absolutizeUrl = require('../shared/absolutizeUrl');

function makeProcessResource({
  fetchUrl,
  findStyleSheetByUrl,
  extractResourcesFromStyleSheet,
  cache = {},
}) {
  return function processResource(absoluteUrl, doc, getResourceUrlsAndBlobs) {
    return cache[absoluteUrl] || (cache[absoluteUrl] = doProcessResource(absoluteUrl));

    function doProcessResource(url) {
      return fetchUrl(url)
        .then(({url, type, value}) => {
          const result = {blobsObj: {[url]: {type, value}}};
          if (/text\/css/.test(type)) {
            const styleSheet = findStyleSheetByUrl(url, doc);
            if (!styleSheet) {
              return result;
            }
            const resourceUrls = extractResourcesFromStyleSheet(styleSheet, doc.defaultView)
              .map(resourceUrl => absolutizeUrl(resourceUrl, url.replace(/^blob:/, '')))
              .filter(filterInlineUrl);
            return getResourceUrlsAndBlobs(resourceUrls).then(({resourceUrls, blobsObj}) => ({
              resourceUrls,
              blobsObj: Object.assign(blobsObj, {[url]: {type, value}}),
            }));
          } else {
            return result;
          }
        })
        .catch(err => {
          console.log('[dom-capture] error while fetching', url, err);
          return {};
        });
    }
  };
}

module.exports = makeProcessResource;
